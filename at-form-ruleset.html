<link rel="import" href="../layout/layout.html">
<link rel="import" href="../at-form-rule-edit/at-form-rule-edit.html">
<link rel="import" href="../at-core-theme/at-core-theme.html">
<link rel="import" href="../at-carbon-icon/at-carbon-icon.html">
<!--
What this component does:
  - this component provides the UI for manipulating sets of rules - rulesets
  - rules can be added, removed, edited, reordered
  - for each rule conditions and actions can be added, removed, edited, reordered

Use cases:
  1) validate HTML form(s)?
  2) validate at-form(s)?
  3) something else ...

Design guidelines:
  1) use MVC
    - use ruleset & value as MODEL
    - condition describes a logical condition (ie some value is <= some other value)
    - action describes an action that can be executed (ie assign value to a field, show alert, etc ... )
    - rule consists of conditions and actions
    - ruleset describes what operations can be performed on what field types for the current situation
    - value describes what rules are initially assigned for the current situation

    - use <template> for VIEW
    - this should work; I assume polymer team fixed them so they work; it shouldn't take much time to figure out how to use
    - alternative to <templates> is function templates - create html programmatically
    - alternative is future proof because polymer team may decide to break <templates>

    - use events and event handlers as CONTROLLER

  2) recycle philosophy from at-form-rule-edit
    - copy / adapt conditions
    - copy / adapt actions
    - copy / adapt "ruleEngine" - checks conditions against current data and executes the actions as necessary
-->

<dom-module id="at-form-ruleset">
  <style>
    .ruleBorder {
      margin: 2px;
      border-color: #aaa;
      border-width: thin;
      border-style: solid;
    }
    .hide-label {
      display: none;
    }
  </style>
  <template>
    <at-core-theme></at-core-theme>
    <div class="vertical layout">
      <div id="labelContainer">
        <label>{{label}}</label>
      </div>
    </div>
    <div class="vertical layout">
      <div class="horizontal layout">
        <div id="addRuleButton" class="ui button">
          <at-carbon-icon icon="now:plus"></at-carbon-icon> Add rule ...
        </div>
      </div>
      <div id="ruleInsertPoint" class="vertical layout">
      </div>
    </div>
  </template>
</dom-module>
<script>
  'use strict';
  //  It appears that .ruleset property and .value property mean the same thing. IMO, .ruleset should be removed because .value is standard way of naming in at-form-* components
  // *ij* ruleset needs config; .ruleset property should be renamed to ruleConfig; this would be either json schema or static config for the at-form-rule-edit
  // use case is that one ruleset should be built for a single schema; multiple rules share a single schema but each rule has its own data
  Polymer({
    is: 'at-form-ruleset',
    _scopeCssViaAttr: true,
    properties: {
      ruleConfig: {
        type: Object,
        value: function () {
          return {};
        },
        observer: 'ruleConfigChanged'
      },
      value: {
        type: Array,
        value: function () {
          return [];
        },
        observer: 'valueChanged',
        notify: true
      },
      disabled: {
        type: Boolean,
        value: false,
        observer: 'disabledChanged'
      },
      label: {
        type: String,
        value: 'Ruleset: '
      },
      hideTitle: {
        type: Boolean,
        value: false,
        observer: 'hideTitleChanged'
      }
    },
    ready: function () {
      var self = this;
      this.$.addRuleButton.addEventListener('mousedown', function (event) {
        self._addRule();
      });
    },
    hideTitleChanged: function (newValue, oldValue) {
      this.toggleClass("hide-label", newValue, this.$.labelContainer);
    },
    __ruleConfigEmpty: function () {
      return Object.keys(this.ruleConfig).length === 0;
    },
    __valueEmpty: function () {
      return this.value.length === 0;
    },
    ruleConfigChanged: function (newValue, oldValue) {
      this.__rebuildHtml();
    },
    valueChanged: function (newValue, oldValue) {
      this.__rebuildHtml();
    },
    disabledChanged: function (newValue, oldValue) {
//      debugger;
      // update add rule button state
      // update move up / down / remove buttons
      var
        uiButtonIndex,
        uiButton,
        uiButtons,
        captionInputIndex,
        captionInput,
        captionInputs,
        ruleEditIndex,
        ruleEdit,
        ruleEdits;

      uiButtons = this.querySelectorAll('.ui.button');
      for (uiButtonIndex = 0; uiButtonIndex < uiButtons.length; uiButtonIndex += 1) {
        if (newValue) {
          uiButtons[uiButtonIndex].classList.add('disabled');
        } else {
          uiButtons[uiButtonIndex].classList.remove('disabled');
        }
      }

      // update caption input field
      captionInputs = this.querySelectorAll('input');
      for (captionInputIndex = 0; captionInputIndex < captionInputs.length; captionInputIndex += 1) {
        if (newValue) {
          captionInputs[captionInputIndex].setAttribute('disabled', 'disabled');
        } else {
          captionInputs[captionInputIndex].removeAttribute('disabled');
        }
      }

      // disable the at-form-rule-edit elements
      ruleEdits = this.querySelectorAll('at-form-rule-edit');
      for (ruleEditIndex = 0; ruleEditIndex < ruleEdits.length; ruleEditIndex += 1) {
        ruleEdit = ruleEdits[ruleEditIndex];
        ruleEdit.disabled = newValue;
      }

    },
    _addRule: function () {
      var ruleIndex = this.value.length;
      var newRule = {
        caption: 'Rule #' + ruleIndex,
        position: ruleIndex,
        rule: {}
      };

      this.value.push(newRule);
      this.__rebuildHtml();
    },
    _removeRule: function (ruleIndex) {
      this.value.splice(ruleIndex, 1);
      this.__rebuildHtml();
    },
    _reorderMoveUp: function (ruleIndex) {
      var moveToIndex = ruleIndex - 1;
      var tmp;

      tmp = this.value[ruleIndex];
      this.value[ruleIndex] = this.value[moveToIndex];
      this.value[moveToIndex] = tmp;

      this.__rebuildHtml();
    },
    _reorderMoveDown: function (ruleIndex) {
      var moveToIndex = ruleIndex + 1;
      var tmp;

      tmp = this.value[ruleIndex];
      this.value[ruleIndex] = this.value[moveToIndex];
      this.value[moveToIndex] = tmp;

      this.__rebuildHtml();
    },

    __rebuildHtml: function () {
      var
        ruleIndex,
        rule,
        ruleHtml,
        isFirst, isLast;

      if (this.__ruleConfigEmpty()) {
        console.debug('Provide rule config for ruleset. Ruleset can not function correctly without rule config');
        return;
      }

      Polymer.dom(this.$.ruleInsertPoint).innerHTML = '';

      for (ruleIndex = 0; ruleIndex < this.value.length; ruleIndex += 1) {
        rule = this.value[ruleIndex];
        isFirst = ruleIndex === 0;
        isLast = ruleIndex === this.value.length - 1;
        ruleHtml = this.__buildRuleHtml(rule, isFirst, isLast, ruleIndex);

        Polymer.dom(this.$.ruleInsertPoint).appendChild(ruleHtml);
      }
    },
    __buildRuleHtml: function (rule, isFirst, isLast, ruleIndexInValueArray) {
      var ruleHtml,
        captionActionsDiv,
        captionInput,
        moveUpBtn,
        moveDownBtn,
        removeBtn,
        ruleDiv,
        atFormRuleElem,
        tmpSpan,
        tmpDiv,
        ruleCaptionText,
        self = this,
        icon,
        text;

      ruleCaptionText = rule && rule.caption ? rule.caption : '';

      // rule html is a div with vertical layout
      // it contains two divs with horizontal layouts
      // first div contains caption and move up / down links and remove link
      // second div contains the at-form-rule-edit component

      // create the html

      ruleHtml = document.createElement('div');
      ruleHtml.classList.add('vertical');
      ruleHtml.classList.add('layout');
      ruleHtml.classList.add('ruleBorder'); // border is for debug purposes

      captionActionsDiv = document.createElement('div');
      captionActionsDiv.classList.add('horizontal');
      captionActionsDiv.classList.add('layout');

      tmpDiv = document.createElement('div');
      tmpSpan = document.createElement('span');
      tmpSpan.textContent = 'Caption : ';
      captionInput = document.createElement('input');
      captionInput.setAttribute('type', 'text');
      captionInput.value = ruleCaptionText;
      captionInput.classList.add('value');
      captionInput.setAttribute('data-rule-index', ruleIndexInValueArray);
      if (this.disabled) {
        captionInput.setAttribute('disabled', 'disabled');
      }
      captionInput.addEventListener('change', function (event) {
        var ruleIndex = parseInt(captionInput.getAttribute('data-rule-index'));
        self.value[ruleIndex].caption = captionInput.value;
      });
      tmpDiv.appendChild(tmpSpan);
      tmpDiv.appendChild(captionInput);

      captionActionsDiv.appendChild(tmpDiv);

      if (!isFirst) {
        tmpDiv = document.createElement('div');
        moveUpBtn = document.createElement('div');

        icon = document.createElement('at-carbon-icon');
        icon.icon = 'arrow-up';
        moveUpBtn.appendChild(icon)

        moveUpBtn.id = 'moveUpButton';
        text = document.createTextNode('Move up');
        moveUpBtn.appendChild(text);
        moveUpBtn.classList.add('ui');
        moveUpBtn.classList.add('right');
        moveUpBtn.classList.add('labeled');
        moveUpBtn.classList.add('icon');
        moveUpBtn.classList.add('button');
        if (this.disabled) {
          moveUpBtn.classList.add('disabled');
        }
        moveUpBtn.setAttribute('data-ruleIndex', ruleIndexInValueArray);
        tmpDiv.appendChild(moveUpBtn);
      }
      captionActionsDiv.appendChild(tmpDiv);

      if (!isLast) {
        tmpDiv = document.createElement('div');
        moveDownBtn = document.createElement('div');

        icon = document.createElement('at-carbon-icon');
        icon.icon = 'arrow-down';
        moveDownBtn.appendChild(icon)

        moveDownBtn.id = 'moveDownButton';
        text = document.createTextNode('Move down');
        moveDownBtn.appendChild(text);
        moveDownBtn.classList.add('ui');
        moveDownBtn.classList.add('right');
        moveDownBtn.classList.add('labeled');
        moveDownBtn.classList.add('icon');
        moveDownBtn.classList.add('button');
        if (this.disabled) {
          moveDownBtn.classList.add('disabled');
        }
        moveDownBtn.setAttribute('data-ruleIndex', ruleIndexInValueArray);
        tmpDiv.appendChild(moveDownBtn);

        captionActionsDiv.appendChild(tmpDiv);
      }

      tmpDiv = document.createElement('div');
      removeBtn = document.createElement('div');

      icon = document.createElement('at-carbon-icon');
      icon.icon = 'cancel';
      removeBtn.appendChild(icon);

      removeBtn.id = 'removeBtn';
      text = document.createTextNode('Remove');
      removeBtn.appendChild(text);
      removeBtn.classList.add('ui');
      removeBtn.classList.add('right');
      removeBtn.classList.add('labeled');
      removeBtn.classList.add('icon');
      removeBtn.classList.add('button');
      if (this.disabled) {
        removeBtn.classList.add('disabled');
      }
      removeBtn.setAttribute('data-ruleIndex', ruleIndexInValueArray);
      tmpDiv.appendChild(removeBtn);

      captionActionsDiv.appendChild(tmpDiv);

      ruleHtml.appendChild(captionActionsDiv);

      ruleDiv = document.createElement('div');
      ruleDiv.classList.add('horizontal');
      ruleDiv.classList.add('layout');

      tmpDiv = document.createElement('div');
      atFormRuleElem = document.createElement('at-form-rule-edit');
      atFormRuleElem.disabled = this.disabled;
      if (this.ruleConfig.properties) {
        atFormRuleElem.schema = this.ruleConfig;
      } else if (this.ruleConfig.conditions && this.ruleConfig.actions) {
        atFormRuleElem.ruleConfig = this.ruleConfig;
      }


      if (rule.rule) {
        atFormRuleElem.value = rule.rule;
      }

      tmpDiv.appendChild(atFormRuleElem);

      ruleDiv.appendChild(tmpDiv);
      ruleHtml.appendChild(ruleDiv);

      // setup event listeners

      if (moveUpBtn) {
        moveUpBtn.addEventListener('click', function (event) {
          var ruleIndex = event.target.getAttribute('data-ruleIndex');
          ruleIndex = parseInt(ruleIndex);
          self._reorderMoveUp(ruleIndex);
          return false;
        });
      }

      if (moveDownBtn) {
        moveDownBtn.addEventListener('click', function (event) {
          var ruleIndex = event.target.getAttribute('data-ruleIndex');
          ruleIndex = parseInt(ruleIndex);
          self._reorderMoveDown(ruleIndex);
          return false;
        });
      }

      removeBtn.addEventListener('click', function (event) {
        var ruleIndex = event.target.getAttribute('data-ruleIndex');
        ruleIndex = parseInt(ruleIndex);
        self._removeRule(ruleIndex);
        return false;
      });

      return ruleHtml;
    }
  });
</script>


<!-- HTML template for the rule
  <div class="vertical layout">
    <div class="horizontal layout">
      <div>
        Caption: <span id="ruleCaption"></span>
      </div>
      <div>
        <a id="moveUpButton" href="javascript:void(0)">Move up</a>
      </div>
      <div>
        <a id="moveDownButton" href="javascript:void(0)">Move down</a>
      </div>
      <div>
        <a id="removeRuleButton" href="javascript:void(0)">Remove</a>
      </div>
    </div>
    <div class="horizontal layout">
      <at-form-rule-edit></at-form-rule-edit>
    </div>
  </div>
-->
