<link rel="import" href="../layout/layout.html">
<link rel="import" href="../at-rule-edit/at-rule-edit.html">
<link rel="import" href="../at-core-theme/at-core-theme.html">
<link rel="import" href="../at-carbon-icon/at-carbon-icon.html">
<!--
What this component does:
  - this component provides the UI for manipulating sets of rules - rulesets
  - rules can be added, removed, edited, reordered
  - for each rule conditions and actions can be added, removed, edited, reordered

Use cases:
  1) validate HTML form(s)?
  2) validate at-form(s)?
  3) something else ...

Design guidelines:
  1) use MVC
    - use ruleset & value as MODEL
    - condition describes a logical condition (ie some value is <= some other value)
    - action describes an action that can be executed (ie assign value to a field, show alert, etc ... )
    - rule consists of conditions and actions
    - ruleset describes what operations can be performed on what field types for the current situation
    - value describes what rules are initially assigned for the current situation

    - use <template> for VIEW
    - this should work; I assume polymer team fixed them so they work; it shouldn't take much time to figure out how to use
    - alternative to <templates> is function templates - create html programmatically
    - alternative is future proof because polymer team may decide to break <templates>

    - use events and event handlers as CONTROLLER

  2) recycle philosophy from at-rule-edit
    - copy / adapt conditions
    - copy / adapt actions
    - copy / adapt "ruleEngine" - checks conditions against current data and executes the actions as necessary
-->

<dom-module id="at-form-ruleset">
  <style>
    .ruleBorder {
      margin: 2px;
      border-color: #aaa;
      border-width: thin;
      border-style: solid;
    }

    .hide-label {
      display: none;
    }

    .custom-margins {
      margin: 6px 0;
    }

    button > span {
      vertical-align: middle;
    }

    #moveUpButton,
    #moveDownButton,
    #removeBtn {
      margin: 0 2px;
    }

    .caption-span {
      align-self: center;
      margin: 0 5px;
    }

    .caption-input {
      font-family: 'Segoe UI', 'Segoe WP', 'Roboto', 'Frutiger', 'Helvetica Neue', Helvetica, Arial, sans-serif;
      margin-right: 5px;
      outline: none;
      -webkit-appearance: none;
      -webkit-tap-highlight-color: rgba(255, 255, 255, 0);
      line-height: 1.2142em;
      padding: 0.67861em 1em;
      font-size: 1em;
      background: #ffffff;
      border: 1px solid rgba(39, 41, 43, 0.15);
      color: #212121;
      border-radius: 2px;
      box-shadow: 0em 0em 0em 0em transparent inset;
      -webkit-transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }

    at-carbon-icon {
      height: 16px;
      width: 16px;
    }

  </style>
  <template>
    <at-core-theme></at-core-theme>
    <div class="vertical layout">
      <div id="labelContainer">
        <h4 class="custom-margins">{{label}}</h4>
      </div>
    </div>
    <div class="vertical layout">
      <div id="ruleInsertPoint" class="vertical layout"></div>
      <div class="horizontal layout">
        <button id="addRuleButton" type="button">
          <at-carbon-icon icon="now:plus"></at-carbon-icon>
          <span>Add rule ...</span>
        </button>
      </div>
    </div>
  </template>
</dom-module>
<script>
  'use strict';
  //  It appears that .ruleset property and .value property mean the same thing. IMO, .ruleset should be removed because .value is standard way of naming in at-form-* components
  // *ij* ruleset needs config; .ruleset property should be renamed to ruleConfig; this would be either json schema or static config for the at-rule-edit
  // use case is that one ruleset should be built for a single schema; multiple rules share a single schema but each rule has its own data
  Polymer({
    is: 'at-form-ruleset',
    _scopeCssViaAttr: true,
    properties: {
      ruleConfig: {
        type: Object,
        value: function() {
          return {};
        },
        observer: 'ruleConfigChanged'
      },
      value: {
        type: Array,
        value: function() {
          return [];
        },
        observer: 'valueChanged'
      },
      disabled: {
        type: Boolean,
        value: false,
        observer: 'disabledChanged'
      },
      label: {
        type: String,
        value: 'Ruleset: '
      },
      hideTitle: {
        type: Boolean,
        value: false,
        observer: 'hideTitleChanged'
      }
    },
    ready: function() {
      var self = this;
      this.$.addRuleButton.addEventListener('click', function(event) {
        event.stopPropagation();
        self._addRule();
      });
    },
    hideTitleChanged: function(newValue, oldValue) {
      this.toggleClass("hide-label", newValue, this.$.labelContainer);
    },
    __ruleConfigEmpty: function() {
      return Object.keys(this.ruleConfig).length === 0;
    },
    __valueEmpty: function() {
      return this.value.length === 0;
    },
    ruleConfigChanged: function(newValue, oldValue) {
      this.__rebuildHtml();
    },
    valueChanged: function(newValue, oldValue) {
      this.__rebuildHtml();
    },
    disabledChanged: function(newValue, oldValue) {
      //      debugger;
      // update add rule button state
      // update move up / down / remove buttons
      var
        uiButtonIndex,
        uiButton,
        uiButtons,
        captionInputIndex,
        captionInput,
        captionInputs,
        ruleEditIndex,
        ruleEdit,
        ruleEdits;

      uiButtons = this.querySelectorAll('.ui.button');
      for (uiButtonIndex = 0; uiButtonIndex < uiButtons.length; uiButtonIndex += 1) {
        if (newValue) {
          uiButtons[uiButtonIndex].classList.add('disabled');
        } else {
          uiButtons[uiButtonIndex].classList.remove('disabled');
        }
      }

      // update caption input field
      captionInputs = this.querySelectorAll('input');
      for (captionInputIndex = 0; captionInputIndex < captionInputs.length; captionInputIndex += 1) {
        if (newValue) {
          captionInputs[captionInputIndex].setAttribute('disabled', 'disabled');
        } else {
          captionInputs[captionInputIndex].removeAttribute('disabled');
        }
      }

      // disable the at-rule-edit elements
      ruleEdits = this.querySelectorAll('at-rule-edit');
      for (ruleEditIndex = 0; ruleEditIndex < ruleEdits.length; ruleEditIndex += 1) {
        ruleEdit = ruleEdits[ruleEditIndex];
        ruleEdit.disabled = newValue;
      }

    },
    _addRule: function() {
      var ruleIndex = this.value.length;
      var newRule = {
        caption: 'Rule #' + ruleIndex,
        position: ruleIndex,
        rule: {
          conditions: {
            kind: "all",
            conditions: []
          },
          actions: []
        }
      };

      this.value.push(newRule);
      this.__rebuildHtml();
      this.fire('value-changed', { value: this.value });
    },
    _removeRule: function(ruleIndex) {
      this.value.splice(ruleIndex, 1);
      this.__rebuildHtml();
      this.fire('value-changed', { value: this.value });
    },
    _reorderMoveUp: function(ruleIndex) {
      var moveToIndex = ruleIndex - 1;
      var tmp;

      tmp = this.value[ruleIndex];
      this.value[ruleIndex] = this.value[moveToIndex];
      this.value[moveToIndex] = tmp;

      this.__rebuildHtml();
      this.fire('value-changed', { value: this.value });
    },
    _reorderMoveDown: function(ruleIndex) {
      var moveToIndex = ruleIndex + 1;
      var tmp;

      tmp = this.value[ruleIndex];
      this.value[ruleIndex] = this.value[moveToIndex];
      this.value[moveToIndex] = tmp;

      this.__rebuildHtml();
      this.fire('value-changed', { value: this.value });
    },

    __rebuildHtml: function() {
      var
        ruleIndex,
        rule,
        ruleHtml,
        isFirst, isLast;

      if (this.__ruleConfigEmpty()) {
        console.debug('Provide rule config for ruleset. Ruleset can not function correctly without rule config');
        return;
      }

      Polymer.dom(this.$.ruleInsertPoint).innerHTML = '';

      for (ruleIndex = 0; ruleIndex < this.value.length; ruleIndex += 1) {
        rule = this.value[ruleIndex];
        isFirst = ruleIndex === 0;
        isLast = ruleIndex === this.value.length - 1;
        ruleHtml = this.__buildRuleHtml(rule, isFirst, isLast, ruleIndex);

        Polymer.dom(this.$.ruleInsertPoint).appendChild(ruleHtml);
      }
    },
    __buildRuleHtml: function(rule, isFirst, isLast, ruleIndexInValueArray) {
      var ruleHtml,
        captionActionsDiv,
        captionInput,
        moveUpBtn,
        moveDownBtn,
        removeBtn,
        ruleDiv,
        atFormRuleElem,
        tmpSpan,
        tmpDiv,
        ruleCaptionText,
        self = this,
        icon,
        text;

      ruleCaptionText = rule && rule.caption ? rule.caption : '';

      // rule html is a div with vertical layout
      // it contains two divs with horizontal layouts
      // first div contains caption and move up / down links and remove link
      // second div contains the at-rule-edit component

      // create the html

      ruleHtml = document.createElement('div');
      Polymer.dom(ruleHtml).classList.add('vertical');
      Polymer.dom(ruleHtml).classList.add('layout');
      Polymer.dom(ruleHtml).classList.add('ruleBorder'); // border is for debug purposes

      captionActionsDiv = document.createElement('div');
      Polymer.dom(captionActionsDiv).classList.add('horizontal');
      Polymer.dom(captionActionsDiv).classList.add('layout');

      tmpDiv = document.createElement('div');
      Polymer.dom(tmpDiv).classList.add('flex');
      Polymer.dom(tmpDiv).classList.add('horizontal');
      Polymer.dom(tmpDiv).classList.add('layout');
      tmpSpan = document.createElement('span');
      Polymer.dom(tmpSpan).innerHTML = 'Caption: ';
      Polymer.dom(tmpSpan).classList.add('caption-span');
      captionInput = document.createElement('input');
      Polymer.dom(captionInput).setAttribute('type', 'text');
      captionInput.value = ruleCaptionText;
      Polymer.dom(captionInput).classList.add('value');
      Polymer.dom(captionInput).classList.add('flex');
      Polymer.dom(captionInput).classList.add('caption-input');
      Polymer.dom(captionInput).setAttribute('data-rule-index', ruleIndexInValueArray);
      if (this.disabled) {
        Polymer.dom(captionInput).setAttribute('disabled', 'disabled');
      }
      captionInput.addEventListener('value-changed', function(event) {
        event.stopPropagation();
        var ruleIndex = parseInt(captionInput.getAttribute('data-rule-index'));
        self.value[ruleIndex].caption = captionInput.value;
      });
      Polymer.dom(tmpDiv).appendChild(tmpSpan);
      Polymer.dom(tmpDiv).appendChild(captionInput);

      Polymer.dom(captionActionsDiv).appendChild(tmpDiv);

      tmpDiv = document.createElement('div');
      if (!isFirst) {
        moveUpBtn = document.createElement('button');

        icon = document.createElement('at-carbon-icon');
        icon.icon = 'arrow-up';
        Polymer.dom(moveUpBtn).appendChild(icon);

        moveUpBtn.id = 'moveUpButton';
        Polymer.dom(moveUpBtn).setAttribute('type', 'button');
        text = document.createElement('span');
        Polymer.dom(text).innerHTML = 'Move up';
        Polymer.dom(moveUpBtn).appendChild(text);
        if (this.disabled) {
          Polymer.dom(moveUpBtn).classList.add('disabled');
        }
        Polymer.dom(moveUpBtn).setAttribute('data-ruleIndex', ruleIndexInValueArray);
        Polymer.dom(tmpDiv).appendChild(moveUpBtn);
      }

      if (!isLast) {
        moveDownBtn = document.createElement('button');

        icon = document.createElement('at-carbon-icon');
        icon.icon = 'arrow-down';
        Polymer.dom(moveDownBtn).appendChild(icon)

        moveDownBtn.id = 'moveDownButton';
        Polymer.dom(moveDownBtn).setAttribute('type', 'button');
        text = document.createElement('span');
        Polymer.dom(text).innerHTML = 'Move down';
        Polymer.dom(moveDownBtn).appendChild(text);
        if (this.disabled) {
          Polymer.dom(moveDownBtn).classList.add('disabled');
        }
        Polymer.dom(moveDownBtn).setAttribute('data-ruleIndex', ruleIndexInValueArray);
        Polymer.dom(tmpDiv).appendChild(moveDownBtn);
      }

      removeBtn = document.createElement('button');

      icon = document.createElement('at-carbon-icon');
      icon.icon = 'trash';
      Polymer.dom(removeBtn).appendChild(icon);

      removeBtn.id = 'removeBtn';
      Polymer.dom(removeBtn).setAttribute('type', 'button');
      text = document.createElement('span');
      Polymer.dom(text).innerHTML = 'Remove';
      Polymer.dom(removeBtn).appendChild(text);
      if (this.disabled) {
        Polymer.dom(removeBtn).classList.add('disabled');
      }
      Polymer.dom(removeBtn).setAttribute('data-ruleIndex', ruleIndexInValueArray);
      Polymer.dom(tmpDiv).appendChild(removeBtn);

      Polymer.dom(captionActionsDiv).appendChild(tmpDiv);

      Polymer.dom(ruleHtml).appendChild(captionActionsDiv);

      ruleDiv = document.createElement('div');
      Polymer.dom(ruleDiv).classList.add('horizontal');
      Polymer.dom(ruleDiv).classList.add('layout');

      tmpDiv = document.createElement('div');
      atFormRuleElem = document.createElement('at-rule-edit');
      atFormRuleElem.disabled = this.disabled;
      if (this.ruleConfig.properties) {
        atFormRuleElem.schema = this.ruleConfig;
      } else if (this.ruleConfig.conditions && this.ruleConfig.actions) {
        atFormRuleElem.ruleConfig = this.ruleConfig;
      }


      if (rule.rule) {
        atFormRuleElem.value = rule.rule;
      }

      Polymer.dom(tmpDiv).appendChild(atFormRuleElem);

      Polymer.dom(ruleDiv).appendChild(tmpDiv);
      Polymer.dom(ruleHtml).appendChild(ruleDiv);

      // setup event listeners

      if (moveUpBtn) {
        moveUpBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          var target = event.currentTarget;
          var ruleIndex = target.getAttribute('data-ruleIndex');
          ruleIndex = parseInt(ruleIndex);
          self._reorderMoveUp(ruleIndex);
          return false;
        });
      }

      if (moveDownBtn) {
        moveDownBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          var target = event.currentTarget;
          var ruleIndex = target.getAttribute('data-ruleIndex');
          ruleIndex = parseInt(ruleIndex);
          self._reorderMoveDown(ruleIndex);
          return false;
        });
      }

      removeBtn.addEventListener('click', function(event) {
        event.stopPropagation();
        var target = event.currentTarget;
        var ruleIndex = target.getAttribute('data-ruleIndex');
        ruleIndex = parseInt(ruleIndex);
        self._removeRule(ruleIndex);
        return false;
      });

      return ruleHtml;
    }
  });
</script>


<!-- HTML template for the rule
  <div class="vertical layout">
    <div class="horizontal layout">
      <div>
        Caption: <span id="ruleCaption"></span>
      </div>
      <div>
        <a id="moveUpButton" href="javascript:void(0)">Move up</a>
      </div>
      <div>
        <a id="moveDownButton" href="javascript:void(0)">Move down</a>
      </div>
      <div>
        <a id="removeRuleButton" href="javascript:void(0)">Remove</a>
      </div>
    </div>
    <div class="horizontal layout">
      <at-rule-edit></at-rule-edit>
    </div>
  </div>
-->
